<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty - Gradebook</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="student-dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Shared variables are assumed to be loaded */
        :root {
            --primary-color: #007bff; --primary-dark: #0056b3;
            --accent-color-1: #ff6b35; --accent-color-2: #28a745;
            --text-color-dark: #212529; --background-light: #ffffff;
            --background-mid: #f4f7fa; --shadow-lift: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Full Width Layout */
        .main-content { margin-left: 0; margin-top: 66px; padding: 30px; }
        footer { margin-left: 0 !important; padding: 20px 0; }
        .dashboard-header { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        .dashboard-header h1 { color: var(--text-color-dark); font-weight: 800; font-size: 36px; margin-bottom: 5px; transition: color 0.3s ease; }
        .dashboard-header h1:hover { color: var(--accent-color-1); cursor: default; }

        /* Course Selection Bar */
        .course-selector { display: flex; gap: 20px; margin-bottom: 30px; padding: 20px; background-color: var(--primary-color); border-radius: 12px; box-shadow: var(--shadow-lift); align-items: center; }
        .course-selector label { color: white; font-weight: 600; font-size: 16px; }
        .course-selector select { padding: 10px; border: none; border-radius: 6px; font-family: 'Poppins', sans-serif; flex-grow: 1; max-width: 300px; }
        .course-selector select:focus { outline: 3px solid var(--accent-color-1); }

        /* Grade Table Style */
        .grade-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .grade-table th, .grade-table td { padding: 15px; text-align: center; border: 1px solid #f0f0f0; transition: background-color 0.3s ease; }
        .grade-table th { background-color: var(--primary-dark); color: white; font-weight: 600; text-transform: uppercase; }
        .grade-table tbody tr:hover { background-color: #ffe0c2; cursor: pointer; }

        .grade-input { width: 70px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        .final-grade { font-weight: 800; color: var(--accent-color-2); }

        /* Header Button (Dashboard Corner Button) */
        .header-home-btn { background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); padding: 8px 15px; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
        .header-home-btn:hover { background-color: var(--accent-color-1); color: white; border-color: var(--accent-color-1); }
    </style>
</head>
<body onload="loadUserData(); populateCourseSelector();">
    <header>
        <nav>
            <div class="logo"><i class="fas fa-graduation-cap"></i> Campus Connect</div>
            <div class="user-menu">
                <a href="#" class="profile-link" id="user-profile-link"><i class="fas fa-user-circle"></i> Loading...</a>
                <button class="header-home-btn" onclick="window.location.href='faculty-dashboard.html'">
                    <i class="fas fa-home"></i> Dashboard
                </button>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="dashboard-header">
            <h1>Gradebook Management</h1>
            <p>Update, review, and post student grades for all course activities.</p>
        </div>

        <div class="course-selector">
            <label for="select-course"><i class="fas fa-chalkboard-teacher"></i> Select Course Gradebook:</label>
            <select id="select-course" onchange="loadGradebook(this.value)">
                </select>
        </div>

        <div class="content-card">
            <h2 id="gradebook-title"><i class="fas fa-file-signature"></i> Grade Sheet</h2>
            <div style="overflow-x: auto;">
                <form id="grade-update-form" onsubmit="saveAllGrades(event)">
                    <table class="grade-table">
                        <thead>
                            <tr id="gradebook-header">
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Total (%)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gradebook-body">
                            </tbody>
                    </table>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;"><i class="fas fa-save"></i> Save All Grades</button>
                </form>
            </div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 Campus Connect | Faculty Dashboard | Gradebook</p>
    </footer>

    <script>
        // --- CENTRALIZED DATA STRUCTURES ---
        
        // Load data dynamically on script execution
        let studentRoster = JSON.parse(localStorage.getItem('facultyStudentRoster')) || [];
        let facultyAssignments = JSON.parse(localStorage.getItem('facultyAssignments')) || [];
        let facultyCourses = JSON.parse(localStorage.getItem('facultyCourses')) || [];
        let courseGrades = JSON.parse(localStorage.getItem('facultyCourseGrades')) || {};

        // --- CPI CALCULATION LOGIC ---

        function calculateAndSaveFacultyCPI() {
            // Function to convert percentage to a simulated 4.0 GPA/CPI point scale
            const percentageToGpa = (percentage) => {
                if (percentage >= 90) return 4.0;
                if (percentage >= 80) return 3.3; 
                if (percentage >= 70) return 3.0; 
                if (percentage >= 60) return 2.0; 
                return 0; // Failure
            };

            const allCoursesGrades = JSON.parse(localStorage.getItem('facultyCourseGrades')) || {};
            const allAssignments = JSON.parse(localStorage.getItem('facultyAssignments')) || [];
            const studentCPIs = {}; 

            // 1. Process Grades per Course per Student
            for (const courseCode in allCoursesGrades) {
                const gradesForCourse = allCoursesGrades[courseCode];
                const assignmentsForCourse = allAssignments.filter(a => a.course === courseCode);
                const maxMarksCourse = assignmentsForCourse.reduce((sum, a) => sum + a.marks, 0);

                for (const studentId in gradesForCourse) {
                    const studentGrades = gradesForCourse[studentId];
                    let marksEarned = 0;
                    
                    for (const assignId in studentGrades) {
                        marksEarned += studentGrades[assignId];
                    }

                    if (maxMarksCourse > 0) {
                        const percentage = (marksEarned / maxMarksCourse) * 100;
                        const gpaPoint = percentageToGpa(percentage);

                        // Initialize student CPI tracker if needed
                        studentCPIs[studentId] = studentCPIs[studentId] || { totalGPA: 0, courseCount: 0 };
                        
                        studentCPIs[studentId].totalGPA += gpaPoint;
                        studentCPIs[studentId].courseCount += 1;
                    }
                }
            }

            // 2. Calculate Final CPI and save
            const finalCPIResults = {};
            for (const studentId in studentCPIs) {
                const data = studentCPIs[studentId];
                if (data.courseCount > 0) {
                    finalCPIResults[studentId] = (data.totalGPA / data.courseCount).toFixed(2);
                }
            }

            // Save the calculated CPIs for the Student Dashboard to read
            localStorage.setItem('studentCPIs', JSON.stringify(finalCPIResults));
        }

        // --- GRADEBOOK RENDERING LOGIC ---

        function getCourseName(courseCode) {
             const course = facultyCourses.find(c => c.code === courseCode);
             return course ? `${courseCode} - ${course.name}` : courseCode;
        }

        function populateCourseSelector() {
            // Re-load data just before populating, in case another page updated courses
            facultyCourses = JSON.parse(localStorage.getItem('facultyCourses')) || [];
            
            const selector = document.getElementById('select-course');
            selector.innerHTML = '';
            
            if (facultyCourses.length === 0) {
                selector.innerHTML = '<option value="">No Active Courses</option>';
            } else {
                facultyCourses.forEach(course => {
                    selector.innerHTML += `<option value="${course.code}">${course.code} - ${course.name}</option>`;
                });
                // Load the gradebook for the first course initially
                loadGradebook(facultyCourses[0].code);
            }
        }

        function loadGradebook(courseCode) {
            // Re-load all necessary data arrays
            studentRoster = JSON.parse(localStorage.getItem('facultyStudentRoster')) || [];
            facultyAssignments = JSON.parse(localStorage.getItem('facultyAssignments')) || [];
            courseGrades = JSON.parse(localStorage.getItem('facultyCourseGrades')) || {};

            const assignments = facultyAssignments.filter(a => a.course === courseCode);
            // Filter students who are actually enrolled in this course
            const studentsInCourse = studentRoster.filter(s => s.course === courseCode); 
            
            const tableHeader = document.getElementById('gradebook-header');
            const tableBody = document.getElementById('gradebook-body');
            
            document.getElementById('gradebook-title').innerHTML = `<i class="fas fa-file-signature"></i> ${getCourseName(courseCode)} Grade Sheet`;
            tableBody.innerHTML = '';

            // --- 1. RENDER HEADER (Assignments) ---
            let headerHTML = '<th>Student ID</th><th>Name</th>';
            let assignmentHeaders = assignments.map(a => `<th data-assignment-id="${a.id}" data-max-marks="${a.marks}">${a.title} (${a.marks})</th>`).join('');
            tableHeader.innerHTML = headerHTML + assignmentHeaders + '<th>Total (%)</th><th>Actions</th>';
            
            const totalMaxMarks = assignments.reduce((sum, a) => sum + a.marks, 0);

            if (studentsInCourse.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="'+ (assignments.length + 4) +'" style="text-align: center; color: #6c757d; padding: 20px;">No students enrolled in this course.</td></tr>';
                 return;
            }

            // --- 2. RENDER ROWS (Students) ---
            studentsInCourse.forEach(student => {
                const studentGrades = courseGrades[courseCode] && courseGrades[courseCode][student.id] ? courseGrades[courseCode][student.id] : {};
                let totalStudentMarks = 0;
                let row = tableBody.insertRow();
                
                let gradeInputs = assignments.map(assignment => {
                    const grade = studentGrades[assignment.id] !== undefined ? studentGrades[assignment.id] : '';
                    totalStudentMarks += parseFloat(grade) || 0;
                    
                    return `
                        <td>
                            <input type="number" 
                                value="${grade}" 
                                min="0" 
                                max="${assignment.marks}" 
                                class="grade-input" 
                                data-student-id="${student.id}" 
                                data-assignment-id="${assignment.id}"
                                onchange="calculateRowTotal(this.closest('tr'))">
                        </td>
                    `;
                }).join('');

                const percentage = totalMaxMarks > 0 ? (totalStudentMarks / totalMaxMarks * 100).toFixed(1) : 0;
                
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td style="text-align: left;">${student.name}</td>
                    ${gradeInputs}
                    <td class="final-grade" data-total-marks="${totalMaxMarks}" data-percentage="${percentage}">${percentage}%</td>
                    <td><button type="button" class="btn btn-action btn-primary" onclick="alert('Post Grades (Save All button recommended)')">Post</button></td>
                `;
            });
        }
        
        function calculateRowTotal(row) {
            const gradeInputs = row.querySelectorAll('.grade-input');
            const totalCell = row.querySelector('.final-grade');
            const totalMaxMarks = parseFloat(totalCell.dataset.totalMarks);
            let currentTotal = 0;
            
            gradeInputs.forEach(input => {
                currentTotal += parseFloat(input.value) || 0; 
            });
            
            const percentage = totalMaxMarks > 0 ? (currentTotal / totalMaxMarks * 100).toFixed(1) : 0;
            totalCell.textContent = `${percentage}%`;
        }
        
        function saveAllGrades(event) {
            event.preventDefault();
            const courseCode = document.getElementById('select-course').value;
            const gradeRows = document.getElementById('gradebook-body').querySelectorAll('tr');
            
            if (!courseCode) {
                alert('Please select a course before saving.');
                return;
            }

            courseGrades[courseCode] = courseGrades[courseCode] || {};
            
            gradeRows.forEach(row => {
                const studentIdCell = row.querySelector('td:first-child');
                if (!studentIdCell) return; 

                const studentId = studentIdCell.textContent;
                const gradeInputs = row.querySelectorAll('.grade-input');
                
                if (studentId && studentId.startsWith('S-')) {
                     courseGrades[courseCode][studentId] = courseGrades[courseCode][studentId] || {};
                
                    gradeInputs.forEach(input => {
                        const assignId = input.dataset.assignmentId;
                        const gradeValue = parseFloat(input.value);
                        
                        if (!isNaN(gradeValue) && input.value !== '') {
                            courseGrades[courseCode][studentId][assignId] = gradeValue;
                        } else if (input.value === '') {
                             delete courseGrades[courseCode][studentId][assignId];
                        }
                    });
                }
            });
            
            // 1. Persist changes to localStorage
            localStorage.setItem('facultyCourseGrades', JSON.stringify(courseGrades));
            
            // 2. CRITICAL STEP: Calculate CPI/GPA immediately after saving grades
            calculateAndSaveFacultyCPI(); 

            alert(`All grades for ${courseCode} saved successfully! CPIs have been recalculated.`);
            loadGradebook(courseCode); // Reload to confirm totals
        }

        // --- UTILITY FUNCTIONS ---
        function loadUserData() {
            const userName = localStorage.getItem('userName') || "Prof. Devesh Tyagi"; 
            const userID = localStorage.getItem('userID') || "F-401";
            const profileLink = document.getElementById('user-profile-link');
            if (profileLink) { profileLink.innerHTML = `<i class="fas fa-user-circle"></i> ${userName} (${userID})`; }
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
             // Attach event listener to the main form to calculate totals dynamically when grades are entered
            document.getElementById('gradebook-body').addEventListener('change', function(e) {
                if (e.target.classList.contains('grade-input')) {
                    calculateRowTotal(e.target.closest('tr'));
                }
            });
            
            // Initial selector population
            populateCourseSelector(); 
        });
    </script>
</body>
</html>